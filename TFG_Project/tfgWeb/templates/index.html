<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TFG</title>
    {% load static %}
    
    <link rel="stylesheet" type="text/css" href="{% static 'css/styles.css' %}">
    <style>
        #overlay {
            position: fixed;
            display: none;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 2;
            cursor: wait;
        }

    </style>

    <script type="text/javascript" src="{% static 'data/json/graphInfo.json.js' %}"></script>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>


</head>
<body>
    <div id="overlay"></div> 

    <h1>Drawing Metabolic Pathways and Networks</h1>

    <label>Choose a metabolic pathway/network:</label>

    <form id="pathwayForm">
        {% csrf_token %}
        <select id="pathwaysList" name="pathwayNames">
            {% for filename in filenames %}
                <option value="{{filename}}">{{ filename }}</option>
            {% endfor %}
        </select>
        <input type="submit" value="Load Pathway" />
        <!-- <button type="button" id="loadPathway">Load Pathway</button> -->
    </form>
    <form id="resetPathway">
        <input type="submit" value="Reset Pathway">
    </form>
    
    <br><br>
    <div class="container">
        <div id="mynetwork"></div>
        <div class="resizer" id="dragMe"></div> 
        <div id="infoConfig">

            <div class="tab">
                <button class="tablinks" onclick="openTab(event, 'Information')">Information</button>
                <button class="tablinks" onclick="openTab(event, 'Actions')">Actions</button>
            </div>
              
             
            <div id="Information" class="tabcontent">
                <div id="graphInfo">
                    <h3>Graph Information</h3>
                    <p id="numNodes"></p>
                    <p id="numEdges"></p>
                    <p id="numCrossings"></p>
                    <p id="numCCs"></p>
                </div>

                <div id="nodeInfo" hidden>
                    <hr>
                    <h3>Node Information</h3>
                    <h4 id="nodeId"></h4>
                    <p>Predecesors:</p>
                    <ul id="predList"></ul>
                    <p>Succesors:</p>
                    <ul id="succList"></ul>
                    <p>Degree:</p>
                </div>
                
            </div>
            
            <div id="Configuration" class="tabcontent">
            </div>
            
            <div id="Actions" class="tabcontent">
                <h4>Split high degree components</h4>
                <p id="highestDegree"></p>
                <form id="splitHighDegreeForm">
                    <input id="degreeThreshhold" type="number" min="0">
                    <input type="submit" value="Split" />
                </form>

                <h4>Break cycle</h4>
                <p id="componentInMostCycles"></p>
                <form id="breakCycle">
                    <input type="submit" value="Split" id="breakCycleButton"/>
                </form>

                <h4>Duplicate selected node</h4>
                <p id="selectedNode"></p>
                <form id="duplicateSelectedNode">
                    <input type="submit" value="Split"/>
                </form>
            </div>

        </div>
    </div>
    {% block javascript %}
    <script>var csrf_token_value = "{{ csrf_token }}";</script>
    <script src="{% static 'js/main.js' %}"></script>
    
    <script>

        $.ajax({
        type: 'POST',
        url: '/update_compounds/',
        data: {
            csrfmiddlewaretoken: csrf_token_value
        },
        success: function (response) {
            console.log("Compounds updated")
        },
        error: function (response) {
            // alert the error if any error occured
            alert('Error');
        }

        })

        var nodeInMostCycles, selectedNode;

        function loadGraph(inputNodes, inputEdges)
        {
            console.log(inputEdges)
            var nodes = new vis.DataSet(
                inputNodes
            );

            // create an array with edges
            var edges = new vis.DataSet(
                inputEdges
                
            );
            // create a network
            var container = document.getElementById('mynetwork');

            // provide the data in the vis format
            var data = {
                nodes: nodes,
                edges: edges
            };

            var options = {
                nodes: {
                    shape: 'box'
                },
                edges: {
                    smooth: false
                },
                physics: false,
                interaction: {
                    // dragNodes: false,// do not allow dragging nodes
                    // zoomView: false, // do not allow zooming
                    // dragView: false  // do not allow dragging
                }
        
            };

            // initialize your network!
            var network = new vis.Network(container, data, options);

            document.getElementById("overlay").style.display = "block";

            $.ajax({
                type: "POST",
                url: "/get_graph_info/",
                data:{
                    pathwayName: $("#pathwaysList option:selected").text(),
                    csrfmiddlewaretoken: csrf_token_value
                },
                success: (data) => {
                    console.log(data);

                    var numNodesElement = document.getElementById("numNodes");
                    numNodesElement.innerHTML = "Number of Nodes: ";
                    numNodesElement.appendChild(document.createTextNode(data.numNodes));

                    var numEdgesElement = document.getElementById("numEdges");
                    numEdgesElement.innerHTML = "Number of Edges: ";
                    numEdgesElement.appendChild(document.createTextNode(data.numEdges));

                    var numCrossingsElement = document.getElementById("numCrossings");
                    numCrossingsElement.innerHTML = "Number of Crossings: ";
                    numCrossingsElement.appendChild(document.createTextNode(data.numCrossings));

                    var numCCsElement = document.getElementById("numCCs");
                    numCCsElement.innerHTML = "Number of Connected Components: ";
                    numCCsElement.appendChild(document.createTextNode(data.numCCs));

                    var highestDegreeElement = document.getElementById("highestDegree");
                    highestDegreeElement.innerHTML = "Highest Degree of a node: ";
                    highestDegreeElement.appendChild(document.createTextNode(data.highestDegree));
            
                    document.getElementById("overlay").style.display = "none";
                },
                error: (error) => {
                    document.getElementById("overlay").style.display = "none";
                    alert('Error');
                }
            });
            
            var numCyclesElement = document.getElementById("componentInMostCycles");
            numCyclesElement.innerHTML = "Number of Cycles: Loading...";            
            numCyclesElement.innerHTML += "<br> Node appearing in most cycles: Loading...";

            $("#breakCycleButton").prop('disabled', true);
            
            $.ajax({
                type: "POST",
                url: "/get_cycles_info/",
                data:{
                    pathwayName: $("#pathwaysList option:selected").text(),
                    csrfmiddlewaretoken: csrf_token_value
                },
                success: (data) => {

                    var numCyclesElement = document.getElementById("componentInMostCycles");
                    numCyclesElement.innerHTML = "Number of Cycles: ";
                    numCyclesElement.appendChild(document.createTextNode(data.numCycles));
                    
                    numCyclesElement.innerHTML += "<br> Node appearing in most cycles: ";
                    numCyclesElement.appendChild(document.createTextNode(data.nodeInMostCycles));

                    nodeInMostCycles = data.nodeInMostCycles;
                    $("#breakCycleButton").prop('disabled', false);

                },
                error: (error) => {
                    $("#breakCycleButton").prop('disabled', false);
                    alert('Error');
                }
            });


            network.on("click", function(params) {
                console.log(params)
                if (params.nodes.length != 0) {
                    document.getElementById('nodeInfo').hidden = false;

                    selectedNode = params.nodes[0];

                    var nodeIdHeader = document.getElementById("nodeId");
                    nodeIdHeader.textContent = "Node ID: " + selectedNode;

                    var selectedNodeIdHeader = document.getElementById("selectedNode");
                    selectedNodeIdHeader.textContent = "Selected Node ID: " + selectedNode;
                    
                    $.ajax({
                        type: "POST",
                        url: "/get_node_info/",
                        data:{
                            pathwayName: $("#pathwaysList option:selected").text(),
                            nodeName: params.nodes[0],
                            csrfmiddlewaretoken: csrf_token_value
                        },
                        success: (data) => {
                            console.log(data);

                            var predList = document.getElementById("predList");
                            predList.innerHTML = "";
                            
                            var predecessors = data.predecessors;

                            for(var i = 0; i < predecessors.length; ++i)
                            {
                                var li = document.createElement("li");
                                li.appendChild(document.createTextNode(predecessors[i]));
                                predList.appendChild(li);

                            }  
                            
                            var succList = document.getElementById("succList");
                            succList.innerHTML = "";

                            var successors = data.successors;

                            for(var i = 0; i < successors.length; ++i)
                            {
                                var li = document.createElement("li");
                                li.appendChild(document.createTextNode(successors[i]));
                                succList.appendChild(li);

                            } 

                        },
                        error: (error) => {
                            alert('Error');
                        }
                    });

                }
                else
                {
                    document.getElementById('nodeInfo').hidden = true;
                }

                

            });

            
        }

        $("#pathwayForm").submit(function (e) {
            // preventing from page reload and default actions
            e.preventDefault();
            // serialize the data for sending the form data.
            var serializedData = $(this).serialize();

            document.getElementById("overlay").style.display = "block";

            // make POST ajax call
            $.ajax({
                type: 'POST',
                url: '/add_pathway/',
                data: {
                    name: $("#pathwaysList option:selected").text(),
                    csrfmiddlewaretoken: csrf_token_value
                },
                success: function (response) {
                    const graphInfo = JSON.parse(response.graphInfo);
                    loadGraph(graphInfo.nodes, graphInfo.edges);
                },
                error: function (response) {
                    // alert the error if any error occured
                    alert('Error');
                }

            })
        })

        $("#resetPathway").submit(function (e) {
            // preventing from page reload and default actions
            e.preventDefault();
            // serialize the data for sending the form data.
            var serializedData = $(this).serialize();
            document.getElementById("overlay").style.display = "block";
            // make POST ajax call
            $.ajax({
                type: 'POST',
                url: '/reset_graph/',
                data: {
                    name: $("#pathwaysList option:selected").text(),
                    csrfmiddlewaretoken: csrf_token_value
                },
                success: function (response) {
                    const graphInfo = JSON.parse(response.graphInfo)
                    loadGraph(graphInfo.nodes, graphInfo.edges)
                },
                error: function (response) {
                    // alert the error if any error occured
                    alert('Error');
                }

            })
        })

        $("#splitHighDegreeForm").submit(function (e) {
            // preventing from page reload and default actions
            e.preventDefault();
            // serialize the data for sending the form data.
            var serializedData = $(this).serialize();
            document.getElementById("overlay").style.display = "block";
            // make POST ajax call
            $.ajax({
                type: 'POST',
                url: '/split_high_degree/',
                data: {
                    name: $("#pathwaysList option:selected").text(),
                    threshhold: $("#degreeThreshhold").val(),
                    csrfmiddlewaretoken: csrf_token_value
                },
                success: function (response) {
                    const graphInfo = JSON.parse(response.graphInfo)
                    loadGraph(graphInfo.nodes, graphInfo.edges)
                },
                error: function (response) {
                    // alert the error if any error occured
                    alert('Error');
                }

            })
        })

        $("#breakCycle").submit(function (e) {
            // preventing from page reload and default actions
            e.preventDefault();
            // serialize the data for sending the form data.
            var serializedData = $(this).serialize();
            document.getElementById("overlay").style.display = "block";
            // make POST ajax call
            $.ajax({
                type: 'POST',
                url: '/duplicate_node/',
                data: {
                    name: $("#pathwaysList option:selected").text(),
                    node: nodeInMostCycles,
                    csrfmiddlewaretoken: csrf_token_value
                },
                success: function (response) {
                    const graphInfo = JSON.parse(response.graphInfo)
                    loadGraph(graphInfo.nodes, graphInfo.edges)
                },
                error: function (response) {
                    // alert the error if any error occured
                    alert('Error');
                }

            })
        })

        $("#duplicateSelectedNode").submit(function (e) {
            // preventing from page reload and default actions
            e.preventDefault();
            // serialize the data for sending the form data.
            var serializedData = $(this).serialize();
            document.getElementById("overlay").style.display = "block";
            // make POST ajax call
            $.ajax({
                type: 'POST',
                url: '/duplicate_node/',
                data: {
                    name: $("#pathwaysList option:selected").text(),
                    node: selectedNode,
                    csrfmiddlewaretoken: csrf_token_value
                },
                success: function (response) {
                    const graphInfo = JSON.parse(response.graphInfo)
                    loadGraph(graphInfo.nodes, graphInfo.edges)
                },
                error: function (response) {
                    // alert the error if any error occured
                    alert('Error');
                }

            })
        })
    </script>
    {% endblock javascript %}
</body>
</html>
